<script>

// protect page
if(localStorage.getItem("login") !== "true"){
   window.location.href="login.html";
}

// ===== SAFE SAVE FUNCTION =====

const token = "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";
const repo = "veera1016/sky";
const file = "data.json";

async function updateAWB(){

try{

const shipment = {
  awb: document.getElementById("awb").value,
  date: document.getElementById("date").value,
  consignee: document.getElementById("consignee").value,
  destination: document.getElementById("destination").value,
  status: document.getElementById("status").value,
  deliveryDate: document.getElementById("deliveryDate").value,
  receiver: document.getElementById("receiver").value,
  deliveryAwb: document.getElementById("deliveryAwb").value,
  progress: []
};

let res = await fetch(`https://api.github.com/repos/${repo}/contents/${file}`);

if(!res.ok){
   alert("Cannot access GitHub file. Check token or repo.");
   return;
}

let data = await res.json();
let content = JSON.parse(atob(data.content));

let index = content.shipments.findIndex(s => s.awb == shipment.awb);

if(index >= 0){
   content.shipments[index] = shipment;
}else{
   content.shipments.push(shipment);
}

await fetch(`https://api.github.com/repos/${repo}/contents/${file}`, {
  method:"PUT",
  headers:{
    "Authorization":"token "+token,
    "Content-Type":"application/json"
  },
  body:JSON.stringify({
    message:"Save shipment "+shipment.awb,
    content:btoa(JSON.stringify(content, null, 2)),
    sha:data.sha
  })
});

alert("Saved Successfully!");

}catch(e){
  console.error(e);
  alert("Error saving shipment. Check console.");
}

}

</script>
